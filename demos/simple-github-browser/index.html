<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <script src="/demos/shared/themes-switcher.js"></script>
    <link rel="stylesheet" href="style.css">
    </style>
    <title></title>
  </head>
  <body>

    <script>
      // script to display message for users to use decent browser
      var e = document.createElement("div"); 
      document.body.appendChild(e);
      setTimeout(function() { e.innerHTML = "<h1>Please update your browser. Internet Explorer and non-chromium Edge are NOT supported. Use FireFox or any Chromium based browser.</h1>" }, 1500);
    </script>

    <template id="utils">
        fetchGitHub
        ${<script>async (url, page, pageSize) => {
          if (url.startsWith("/search")) {
              let response = JSON.parse('{"total_count":5,"incomplete_results":false,"items":[{"login":"A","id":1410106,"node_id":"MDQ6VXNlcjE0MTAxMDY=","avatar_url":"https://avatars2.githubusercontent.com/u/1410106?v=4","gravatar_id":"","url":"https://api.github.com/users/A","html_url":"https://github.com/A","followers_url":"https://api.github.com/users/A/followers","following_url":"https://api.github.com/users/A/following{/other_user}","gists_url":"https://api.github.com/users/A/gists{/gist_id}","starred_url":"https://api.github.com/users/A/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/A/subscriptions","organizations_url":"https://api.github.com/users/A/orgs","repos_url":"https://api.github.com/users/A/repos","events_url":"https://api.github.com/users/A/events{/privacy}","received_events_url":"https://api.github.com/users/A/received_events","type":"User","site_admin":false,"score":167.8391},{"login":"snyff","id":45491,"node_id":"MDQ6VXNlcjQ1NDkx","avatar_url":"https://avatars1.githubusercontent.com/u/45491?v=4","gravatar_id":"","url":"https://api.github.com/users/snyff","html_url":"https://github.com/snyff","followers_url":"https://api.github.com/users/snyff/followers","following_url":"https://api.github.com/users/snyff/following{/other_user}","gists_url":"https://api.github.com/users/snyff/gists{/gist_id}","starred_url":"https://api.github.com/users/snyff/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/snyff/subscriptions","organizations_url":"https://api.github.com/users/snyff/orgs","repos_url":"https://api.github.com/users/snyff/repos","events_url":"https://api.github.com/users/snyff/events{/privacy}","received_events_url":"https://api.github.com/users/snyff/received_events","type":"User","site_admin":false,"score":66.34858},{"login":"adamwiggins","id":177,"node_id":"MDQ6VXNlcjE3Nw==","avatar_url":"https://avatars0.githubusercontent.com/u/177?v=4","gravatar_id":"","url":"https://api.github.com/users/adamwiggins","html_url":"https://github.com/adamwiggins","followers_url":"https://api.github.com/users/adamwiggins/followers","following_url":"https://api.github.com/users/adamwiggins/following{/other_user}","gists_url":"https://api.github.com/users/adamwiggins/gists{/gist_id}","starred_url":"https://api.github.com/users/adamwiggins/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adamwiggins/subscriptions","organizations_url":"https://api.github.com/users/adamwiggins/orgs","repos_url":"https://api.github.com/users/adamwiggins/repos","events_url":"https://api.github.com/users/adamwiggins/events{/privacy}","received_events_url":"https://api.github.com/users/adamwiggins/received_events","type":"User","site_admin":false,"score":57.996746},{"login":"Amichai","id":313874,"node_id":"MDQ6VXNlcjMxMzg3NA==","avatar_url":"https://avatars3.githubusercontent.com/u/313874?v=4","gravatar_id":"","url":"https://api.github.com/users/Amichai","html_url":"https://github.com/Amichai","followers_url":"https://api.github.com/users/Amichai/followers","following_url":"https://api.github.com/users/Amichai/following{/other_user}","gists_url":"https://api.github.com/users/Amichai/gists{/gist_id}","starred_url":"https://api.github.com/users/Amichai/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Amichai/subscriptions","organizations_url":"https://api.github.com/users/Amichai/orgs","repos_url":"https://api.github.com/users/Amichai/repos","events_url":"https://api.github.com/users/Amichai/events{/privacy}","received_events_url":"https://api.github.com/users/Amichai/received_events","type":"User","site_admin":false,"score":56.702385},{"login":"adulau","id":3309,"node_id":"MDQ6VXNlcjMzMDk=","avatar_url":"https://avatars2.githubusercontent.com/u/3309?v=4","gravatar_id":"","url":"https://api.github.com/users/adulau","html_url":"https://github.com/adulau","followers_url":"https://api.github.com/users/adulau/followers","following_url":"https://api.github.com/users/adulau/following{/other_user}","gists_url":"https://api.github.com/users/adulau/gists{/gist_id}","starred_url":"https://api.github.com/users/adulau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adulau/subscriptions","organizations_url":"https://api.github.com/users/adulau/orgs","repos_url":"https://api.github.com/users/adulau/repos","events_url":"https://api.github.com/users/adulau/events{/privacy}","received_events_url":"https://api.github.com/users/adulau/received_events","type":"User","site_admin":false,"score":56.33152}]}');
              response.items = [response.items[page-1]];
              return response;
          }
          if (url.startsWith("/users")) {
            return {message: 'no request for you!'}
          }
          
          /*
          
          let result = await(await fetch(`https://api.github.com${url}`, {cache: "force-cache"})).json();
          if (result.message) {
            result.message = result.message.replace("documentation", `<a href=${result.documentation_url}>documentation</a>`);
          }
          for(let [key, value] of Object.entries(result)) {
            if (!value) {
              result[key] = "";
            }
          }
          return result;
          */
        }</script>}
    </template>

    <template data-tag="github-result">
      ${<script>
      async () => {
          const {publish, subscribe} = this.template.import("ihjs/pubsub");
          const {fetchGitHub} = this.template.import("template-import!utils");

          if (!this.details) {
            this.details = await fetchGitHub(`/users/${this.item.login}`);
          }

          this.error = null;
          if (this.details.message) {
            this.error = "<li>" + this.details.message + "</li>"; 
          }
          this.saved = localStorage.getItem("item-" + this.item.id) !== null;
          
          this.starElement = element => {
            if (this.saved) {
              element.html("&#11088;").attr("title", "remove from saved");
            } else {
              element.html("&#10032;").attr("title", "save");
            }
          };

          subscribe("item/removed/" + this.item.id, () => {
            this.saved = false;
            this.starElement(this.template.model.star);
          });

          this.starClick = e => {
            const key = "item-" + this.item.id;
            if (!this.saved) {
              localStorage.setItem(key, JSON.stringify({
                item: this.item,
                details: this.details
              }));
              this.saved = true;
              publish("item/saved", key);
            } else {
              localStorage.removeItem(key);
              this.saved = false;
              publish("item/removed", key);
              publish("item/removed/" + this.item.id);
            }
            this.starElement(e.target);
          };

          this.rendered = () => this.template.model.star && this.starElement(this.template.model.star);
      }
      </script>}
      <div class="panel">
          ${this.error == null ? "" : `
            <div id="star" class="panel-save" onclick="starClick" ></div>
          `}
          <span class="panel-info">
              <a href="#/details/${() => this.item.id + (this.details ? '/' + encodeURIComponent(JSON.stringify(this.details)) : '')}">See more details</a>
              ${this.dataset.doNotShowScore ? "" : `
                <div>Search score = ${this.item.score}</div>
              `}
          </span>

          <a href="${this.item.html_url}"><img src="${this.item.avatar_url}" /></a>
          <span class="item-info">
            <ul id="item-list">
              <li>
                <strong>${this.item.type}:</strong>&nbsp;<a href="${this.item.html_url}">${this.item.login}</a>
              </li>
              ${() => this.error || `
              <li>
                  <strong>Name:</strong>&nbsp;${this.details.name}
              </li>
              <li>
                  <strong>Company:</strong>&nbsp;<a href="${this.details.company ? 'https://www.google.com/search?q=' + this.details.company : ''}">${this.details.company}</a>
              </li>
              <li>
                  <strong>Location:</strong>&nbsp;<a href="${this.details.location ? 'https://www.google.com/maps?q=' + this.details.location : ''}">${this.details.location}</a>
              </li>
              <li>
                  <strong>Blog:</strong>&nbsp;<a href="${this.details.blog}">${this.details.blog}</a>
              </li>
              <li>
                  <strong>Email:</strong>&nbsp;<a href="${this.details.email}">${this.details.email}</a>
              </li>
              `}
            </ul>
          </div>
      </div>
    </template>

    <template data-route="/details">
      ${<script>
        () => this.paramsMap = params => {
          return params.length > 0 && params.length < 3 ? {itemId: params[0], details: (params.length === 2 ? JSON.parse(params[1]) : undefined)} : false
        }
      </script>}

      <h3>Details for <code>GitHub <img src="favicon.ico" /></code> user search. Total <code id=total></code> items.</h3>
      <button onclick="window.history.back();">Go back</button>

    <details open>
        <summary>Beauxbatons Academy of Magic</summary>
        <p>
            If you like your magic served with a dash of savoir faire, this school is for you. Beauxbatons welcomes a multitude of students of different nationalities, mainly French, but also Spanish, Portuguese, Dutch, Luxembourgian and Belgian.
        </p>
    </details>
    

    ${<script>() => {
      console.log(this);
    }
    </script>}
    </template>

    <template data-route="/saved-items">
      <h3>Your saved items of your <code>GitHub <img src="favicon.ico" /></code> user search. Total <code id=total></code> items.</h3>
      <button onclick="window.history.back();">Go back</button>
      <div id="results"></div>
      ${<script>() => {
        this.count = 0;
        const 
          addItem = key => {
            let value = JSON.parse(localStorage.getItem(key));
            let element = `<github-result id=${key} data-do-not-show-score='true' data-remove-on-unstar='true'></github-result>`.dom();
            element.item = value.item;
            element.details = value.details;
            this.model.results.append(element);
          };

        const {subscribe} = this.template.import("ihjs/pubsub");

        subscribe("item/removed", key => {
          this.model.results.find("#" + key).remove()
          this.model.total.html(--this.count);
        });
        subscribe("item/saved", key => {
          let e = this.model.results.find("#" + key);
          if (e.length) {
            return;
          }
          addItem(key);
          this.model.total.html(++this.count);
        });
        this.template.rendered = () => {
          this.model.results.html("");
          for(let key in localStorage) {
            if (key.startsWith("item-")) {
              addItem(key);
              this.count++;
            }
          }
          this.model.total.html(this.count);
        };

      }
      </script>}
    </template>

    <template data-route="/">
      ${<script>
        /*
        * resolve url parameters for this route:
        * * more then two parameters is forbidden for this route - return false
        * * return `{page: Number, query: param}` object which is merged with template instance 
        */
        () => this.paramsMap = params => {
          if (params.length > 2) {
            return false;
          }
          let page = (params.length > 0 ? Number(params[0]) : 1)
          if (isNaN(page)) {
            page = 1;
          }
          return {
            page: page,
            query: (params.length > 1 ? params[1] : "")
          }
        }
      </script>}

      <p>
        <label for="query">
          <h3>Enter valid 
            <code>GitHub 
                <img src="favicon.ico" />
            </code> query into search box and hit key <code>enter</code> or <code>search</code> button.
          </h3>
          <div class="info-text ">
            <span>Example of search query 
              <code class="example" onclick="e => {this.model.query.value = e.target.innerText.trim(); this.model.query.focus();}">
                tom repos:>42 followers:>1000
              </code> - 
              username or email starts with "tom" and with more than 42 repositories, and only if they have over 1,000 followers. See
              <a href="https://developer.github.com/v3/search/#constructing-a-search-query" target="_blank">docs &nbsp;&#x2197;</a> for more info.
            </span>
            <p>
                <strong>Note:</strong> Rate limit for unauthenticated requests associated with the originating IP address is up to <strong>60 requests per hour</strong>. 
                To increase your requests limit up to <strong>5000 requests per hour</strong>, you'll need to 
                <a href="authorize" onclick="e => {e.preventDefault(); window.open('', '_blank', 'menubar=no').document.write('<h1>If you would like version with implemented GitHub authorization, contact me at <a href=\'mailto:vbilopav@gmail.com\'>vbilopav@gmail.com<a> </h1>');}">login to your GitHub account</a>
            </p>
          </div>
        </label>
        <p>
          <input 
            type="text" id="query" 
            placeholder="search box" autofocus 
            spellcheck="false" 
            autocomplete="off"
            onkeypress="e => e.keyCode === 13 && this.model.search.click()"
            onfocus="this.select()"
          />
          <a style="float: right;" href="#/saved-items/">view saved items</a>
          <button id="search" onclick="() => document.location.hash = '#/1/' + this.model.query.value.replace(new RegExp('/', 'g'), '')">search</button>
        </p>
        
        <div id="results-header" class="results-info">
          <code id="msg">results</code>
          <button id="next" onclick="() => document.location.hash = '#/' + ++this.page + '/' + this.query">next</button>
          <button id="prev" onclick="() => document.location.hash = '#/' + --this.page + '/' + this.query">prev</button>
        </div>
      </p>

      <div id="results">
      </div>

      <div id="results-header" class="results-info">
          <code id="msg">results</code>
          <button id="next" onclick="() => document.location.hash = '#/' + ++this.page + '/' + this.query">next</button>
          <button id="prev" onclick="() => document.location.hash = '#/' + --this.page + '/' + this.query">prev</button>
      </div>

      ${<script>
      () => {

          const pageSize = 1;
          const {fetchGitHub} = this.template.import("template-import!utils");
          const enableNextPrev = (next, prev) => {
            // toggle disabled attributes
            this.model.prev.attr("disabled", "", !prev);
            this.model.next.attr("disabled", "", !next);
          };
          
          this.performSearch = async () => {
              // `html` element extension acts exactly like jquery `html` method
              this.model.results.html("");
              this.model.resultsHeader.hideElement();
              if (!this.query) {
                return;
              }
              const result = await fetchGitHub(`/search/users?q=${this.query}&page=${this.page}&per_page=${pageSize}`, this.page, pageSize);
              this.model.resultsHeader.showElement();
              if (result.message) {
                this.model.msg.html(result.message);
                enableNextPrev(false, false);
                return;
              }
              this.model.msg.html(`Result ${(this.page * pageSize) - pageSize + 1}-${this.page * pageSize} of total ${result.total_count}.`)
              this.template.forEach(result.items, item => {
                // `dom` string extension creates dom object from string
                let element = "<github-result></github-result>".dom();
                // assign result item to element instance to be used in github-result element
                element.item = item;
                // `append` element extension acts exactly like jquery `append` method
                this.model.results.append(element);
              });
              enableNextPrev(this.page < Math.floor(result.total_count / pageSize), this.page > 1);
          }

          // remove "/" characters from search query and redirect browser to ne location
          //this.searchClick = () => document.location.hash = '#/1/' + this.model.query.value.replace(new RegExp("/", 'g'), "")

          // call search on rendered event to ensure that model is constructed
          this.template.rendered = async ({revealed}) => {
            if (revealed) {
              // No need to re-render already rendered view. Remove this to have search triggered on every navigate within this route.
              return;
            }
            await this.performSearch();
          }

      }
      </script>}
    </template>

    <script type="module" src="../../../src/ihjs/dev/ihjs.js"></script>
    <!-- <script type="module" src="../../../src/ihjs/build/1.2.0/ihjs.js"></script> -->

  </body>
</html>
